name: Release to Community Operators

on:
  release:
    types: [published]
  workflow_dispatch:
    branches:
      - main
    inputs:
      version:
        description: 'Version to release (e.g., 0.2.1)'
        required: true
        type: string
      channels:
        description: 'Bundle channels'
        required: false
        default: 'fast-v0'
        type: string
      default_channel:
        description: 'Default channel'
        required: false
        default: 'fast-v0'
        type: string
      dry_run:
        description: 'Dry run (do not push changes)'
        required: false
        default: false
        type: boolean

env:
  REGISTRY: quay.io

  # Operator configuration
  OPERATOR_NAME: clusterpulse
  OPERATOR_IMAGE: clusterpulse/operator #docker.io/clusterpulse/clusterpulse-operator
  
  # Community operators configuration
  COMMUNITY_REPO_UPSTREAM: redhat-openshift-ecosystem/community-operators-prod
  COMMUNITY_REPO_FORK: ${{ github.repository_owner }}/community-operators-prod
  COMMUNITY_REPO_BRANCH: main
  
  # Bundle configuration
  BUNDLE_IMAGE_REGISTRY: quay.io/community-operator-pipeline-prod
  
  # Catalog template channels
  CATALOG_TEMPLATE_CHANNELS: "Fast"

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    steps:
      - name: Determine version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "release" ]; then
            VERSION="${{ github.event.release.tag_name }}"
            # Strip 'v' prefix if present
            VERSION="${VERSION#v}"
          else
            VERSION="${{ inputs.version }}"
          fi
          
          # Validate version format (x.x.x)
          if ! [[ "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Error: Version '$VERSION' does not match format x.x.x"
            exit 1
          fi
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Releasing version: $VERSION"

      - name: Set bundle configuration
        id: config
        run: |
          if [ "${{ github.event_name }}" = "release" ]; then
            CHANNELS="${{ vars.BUNDLE_CHANNELS || 'fast-v0' }}"
            DEFAULT_CHANNEL="${{ vars.BUNDLE_DEFAULT_CHANNEL || 'fast-v0' }}"
          else
            CHANNELS="${{ inputs.channels }}"
            DEFAULT_CHANNEL="${{ inputs.default_channel }}"
          fi
          
          echo "channels=$CHANNELS" >> $GITHUB_OUTPUT
          echo "default_channel=$DEFAULT_CHANNEL" >> $GITHUB_OUTPUT
          echo "ðŸ”§ Channels: $CHANNELS, Default: $DEFAULT_CHANNEL"

      - name: Checkout operator repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install operator-sdk
        run: |
          OPERATOR_SDK_VERSION="v1.41.1"
          curl -sSLo operator-sdk "https://github.com/operator-framework/operator-sdk/releases/download/${OPERATOR_SDK_VERSION}/operator-sdk_linux_amd64"
          chmod +x operator-sdk
          sudo mv operator-sdk /usr/local/bin/

      - name: Install kustomize
        run: |
          curl -sSLo - https://github.com/kubernetes-sigs/kustomize/releases/download/kustomize/v5.6.0/kustomize_v5.6.0_linux_amd64.tar.gz | tar xzf -
          chmod +x kustomize
          sudo mv kustomize /usr/local/bin/

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.QUAY_USERNAME }}
          password: ${{ secrets.QUAY_TOKEN }}

      - name: Build and push operator image
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          IMG="${{ env.REGISTRY }}/${{ env.OPERATOR_IMAGE }}:${VERSION}"
          DRY_RUN="${{ github.event.inputs.dry_run }}"
          
          echo "Building operator image: $IMG"
          make docker-build IMG="$IMG"
          
          if [ "$DRY_RUN" != "true" ]; then
            echo "Pushing operator image: $IMG"
            make docker-push IMG="$IMG"
          else
            echo "Dry run - skipping push"
          fi

      - name: Generate bundle
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          CHANNELS="${{ steps.config.outputs.channels }}"
          DEFAULT_CHANNEL="${{ steps.config.outputs.default_channel }}"
          IMG="${{env.REGISTRY}}/${{ env.OPERATOR_IMAGE }}:${VERSION}"
          
          echo "ðŸ“‹ Generating bundle for version $VERSION"
          
          # Update the manager image reference
          cd config/manager && kustomize edit set image controller="$IMG" && cd ../..
          
          # Generate bundle
          VERSION="$VERSION" CHANNELS="$CHANNELS" DEFAULT_CHANNEL="$DEFAULT_CHANNEL" make bundle
          
          # Validate bundle
          operator-sdk bundle validate ./bundle
          
          echo "âœ… Bundle generated and validated"

      - name: Import GPG key
        uses: crazy-max/ghaction-import-gpg@v6
        with:
          gpg_private_key: ${{ secrets.GPG_PRIVATE_KEY }}
          passphrase: ${{ secrets.GPG_PASSPHRASE }}
          git_user_signingkey: true
          git_commit_gpgsign: true

      - name: Generate GitHub App token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.DEPLOYER_APP_ID }}
          private-key: ${{ secrets.DEPLOYER_APP_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}
          repositories: community-operators-prod

      - name: Sync fork with upstream via GitHub API
        if: github.event.inputs.dry_run != 'true'
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          echo "ðŸ”„ Syncing fork with upstream via GitHub API..."
          gh repo sync "${{ env.COMMUNITY_REPO_FORK }}" \
            --source "${{ env.COMMUNITY_REPO_UPSTREAM }}" \
            --branch "${{ env.COMMUNITY_REPO_BRANCH }}" \
            --force
          echo "âœ… Fork synced with upstream"

      - name: Clone community operators fork
        run: |
          echo "ðŸ“¥ Cloning community operators fork"
          git clone "https://x-access-token:${{ steps.app-token.outputs.token }}@github.com/${{ env.COMMUNITY_REPO_FORK }}.git" community-operators

      - name: Copy bundle to community operators
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          OPERATOR_DIR="community-operators/operators/${{ env.OPERATOR_NAME }}"
          VERSION_DIR="${OPERATOR_DIR}/${VERSION}"
          
          echo "ðŸ“ Creating version directory: $VERSION_DIR"
          mkdir -p "$VERSION_DIR"
          
          # Copy bundle contents
          cp -r bundle/manifests "$VERSION_DIR/"
          cp -r bundle/metadata "$VERSION_DIR/"
          
          # Copy tests if they exist
          if [ -d "bundle/tests" ]; then
            cp -r bundle/tests "$VERSION_DIR/"
          fi
          
          echo "âœ… Bundle contents copied"
          ls -la "$VERSION_DIR/"

      - name: Create release-config.yml
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          VERSION_DIR="community-operators/operators/${{ env.OPERATOR_NAME }}/${VERSION}"
          CHANNELS="${{ env.CATALOG_TEMPLATE_CHANNELS }}"
          
          printf '%s\n' \
            "---" \
            "catalog_templates:" \
            "  - template_name: semver.yaml" \
            "    channels:" \
            "      - ${CHANNELS}" \
            > "${VERSION_DIR}/release-config.yml"
          
          echo "âœ… Created release-config.yml:"
          cat "${VERSION_DIR}/release-config.yml"

#      - name: Install yq
#        uses: mikefarah/yq@v4

#      - name: Update semver.yaml catalog template
#        run: |
#          VERSION="${{ steps.version.outputs.version }}"
#          OPERATOR_DIR="community-operators/operators/${{ env.OPERATOR_NAME }}"
#          SEMVER_FILE="${OPERATOR_DIR}/catalog-templates/semver.yaml"
#          NEW_IMAGE="${{ env.BUNDLE_IMAGE_REGISTRY }}/${{ env.OPERATOR_NAME }}:${VERSION}"
#          
#          # Create catalog-templates directory if it doesn't exist
#          mkdir -p "${OPERATOR_DIR}/catalog-templates"
#          
#          if [ -f "$SEMVER_FILE" ]; then
#            echo "ðŸ“ Updating existing semver.yaml"
#            
#            # Check if image already exists
#            if yq ".Fast.Bundles[].Image" "$SEMVER_FILE" | grep -q "$NEW_IMAGE"; then
#              echo "âš ï¸ Image $NEW_IMAGE already exists in semver.yaml"
#            else
#              # Append new image to the Bundles array (newest first)
#              #yq -i ".Fast.Bundles = [{\"Image\": \"$NEW_IMAGE\"}] + .Fast.Bundles" "$SEMVER_FILE"
#              yq -i ".Fast.Bundles = .Fast.Bundles + [{\"Image\": \"$NEW_IMAGE\"}]" "$SEMVER_FILE"
#              echo "âœ… Added image: $NEW_IMAGE"
#            fi
#          else
#            echo "ðŸ“ Creating new semver.yaml"
#            printf '%s\n' \
#              "---" \
#              "Schema: olm.semver" \
#              "GenerateMajorChannels: true" \
#              "GenerateMinorChannels: false" \
#              "Fast:" \
#              "  Bundles:" \
#              "    - Image: ${NEW_IMAGE}" \
#              > "$SEMVER_FILE"
#          fi
#          
#          echo "ðŸ“„ Current semver.yaml:"
#          cat "$SEMVER_FILE"

      - name: Configure Git for signed commits
        run: |
          cd community-operators
          git config user.name "${{ vars.GIT_COMMIT_NAME || github.actor }}"
          git config user.email "${{ vars.GIT_COMMIT_EMAIL || format('{0}@users.noreply.github.com', github.actor) }}"

      - name: Commit changes
        id: commit
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          cd community-operators
          
          git add -A
          
          if git diff --staged --quiet; then
            echo "âš ï¸ No changes to commit"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "ðŸ“ Committing changes"
            git commit -S -s -m "${{ env.OPERATOR_NAME }} (${VERSION})"
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "âœ… Committed with signed-off-by and GPG signature"
          fi

      - name: Push changes
        id: push
        if: steps.commit.outputs.has_changes == 'true' && github.event.inputs.dry_run != 'true'
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          cd community-operators
          
          # Create a branch for the PR
          BRANCH_NAME="${{ env.OPERATOR_NAME }}-${VERSION}"
          git checkout -b "$BRANCH_NAME"
          
          echo "ðŸš€ Pushing branch: $BRANCH_NAME"
          git push -u origin "$BRANCH_NAME" --force
          
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "âœ… Changes pushed to $BRANCH_NAME"

      - name: Create Pull Request
        id: create-pr
        if: steps.push.outputs.branch_name != ''
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          BRANCH_NAME="${{ steps.push.outputs.branch_name }}"
          
          PR_TITLE="${{ env.OPERATOR_NAME }} (${VERSION})"
          
          # Create PR body
          PR_BODY="## ${{ env.OPERATOR_NAME }} release ${VERSION}
          
          *Automated release created by [GitHub Actions](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})*"
          
          echo "ðŸ”— Creating pull request..."
          
          PR_URL=$(gh pr create \
            --repo "${{ env.COMMUNITY_REPO_UPSTREAM }}" \
            --head "${{ github.repository_owner }}:${BRANCH_NAME}" \
            --base "${{ env.COMMUNITY_REPO_BRANCH }}" \
            --title "$PR_TITLE" \
            --body "$PR_BODY")
          
          echo "âœ… Pull request created: $PR_URL"
          echo "pr_url=$PR_URL" >> $GITHUB_OUTPUT

      - name: Summary
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          DRY_RUN="${{ github.event.inputs.dry_run }}"
          
          echo "## Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Version:** $VERSION" >> $GITHUB_STEP_SUMMARY
          echo "- **Operator Image:** ${{ env.REGISTRY }}/${{ env.OPERATOR_IMAGE }}:${VERSION}" >> $GITHUB_STEP_SUMMARY
          echo "- **Bundle Image:** ${{ env.BUNDLE_IMAGE_REGISTRY }}/${{ env.OPERATOR_NAME }}:$VERSION" >> $GITHUB_STEP_SUMMARY
          echo "- **Channels:** ${{ steps.config.outputs.channels }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Default Channel:** ${{ steps.config.outputs.default_channel }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "$DRY_RUN" = "true" ]; then
            echo "âš ï¸ **This was a dry run - no changes were pushed**" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… Changes have been pushed to the community operators fork" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Next Steps:**" >> $GITHUB_STEP_SUMMARY
            echo "1. Navigate to your fork: https://github.com/${{ env.COMMUNITY_REPO_FORK }}" >> $GITHUB_STEP_SUMMARY
            echo "2. Create a pull request to: https://github.com/${{ env.COMMUNITY_REPO_UPSTREAM }}" >> $GITHUB_STEP_SUMMARY
          fi
